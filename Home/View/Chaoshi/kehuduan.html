<extend name="Public/base" />

<block name="head">
    <css href="__PUBLIC__/assets/css/ui.jqgrid.css" />
    <js href="__PUBLIC__/assets/js/jqgrid/jquery.jqGrid.js" />
    <js href="__PUBLIC__/assets/js/jqgrid/i18n/grid.locale-cn.js" />
    <css href="__PUBLIC__/bootstrap/daterangepicker/daterangepicker-bs3.css" />
    <js href="__PUBLIC__/bootstrap/daterangepicker/moment.min.js" />
    <js href="__PUBLIC__/bootstrap/daterangepicker/daterangepicker.js" />
	<js href="__PUBLIC__/layer/layer.js" />
	<style>
	   .mgb15{margin-bottom:15px;}
	   .labelbold{font-weight:bold;
	   }
       .biaodan{float:left;padding-left:15px;}

	   @media (min-width: 992px) {
		  .modal-lg {
			width: 700px;
		  }
		}
	 	 body .search-bar input,body .search-bar select{
		display:inline-block;
		height:30px;
		font-size:14px;
		line-height:
		color:#555555;
		vertical-align:middle;
		-webkit-border-radius:4px !important;
		-moz-border-radius:4px !important;
		border-radius:4px !important;
		border-color:#a4bed4;
		text-align:left;
		padding:4px 6px;
	 }
	 body .search-bar input{width:200px;}
	 body .search-bar select{width:100px;}
	 .btn1{
		    font-size:12px;	
			height:30px;
			 width:90px;
			-webkit-border-radius:2px;
			-moz-border-radius:2px;
			border-radius:2px;
			border:0;
			text-shadow:none;
			background-image:none;
			vertical-align:middle;
			color:#ffffff;
		 }
	</style>
</block>

<block name="content">
<div class="row">
  <div class="col-xs-12 col-sm-12">
  <!--  <div class="alert alert-warning bolder"id="ceshi">充值金额 <span class="orange" >0.00</span> 元</div>  
  </div> -->
</div>

			<ul class="nav nav-tabs padding-12 tab-color-blue background-blue" id="myTab4" style="font-size:12px;">
                <li class="active">
                    <a data-toggle="tab" href="#khdxs">客户端销售</a>
                </li>
                <li>
                    <a data-toggle="tab" href="#btxs">吧台销售</a>
                </li>
            </ul>
			<div class="tab-content" >
				<div id="khdxs" class="tab-pane in active" >

                    <div class="row search-bar" >
                        <form >
                        <span class="mgb15 biaodan">
                            出货时间<input type="text" name="daterange1" id="daterange1" class="daterange" style="width:310px;"  placeholder="请选择日期" required /> 
                        </span>
						
						<span class="biaodan mgb15">领取状态
							<select id="lingqu_status" name="lingqu_status">
							   <option value="0">全部</option>
							   <option value="2">已领取</option>						  						   
							   <option value="1">未领取</option>

							</select>
						</span>

                         <span class="biaodan mgb15">
                            <span>订单号 <input type="text" name="cardno1" id="cardno1" style="width:150px;" placeholder="请输入订单号"/></span>
                        </span>
                        <span class="biaodan mgb15"><button type="button" class="btn1 btn-purple btn-sm" onclick="doSearch1()" id="sousuo1">搜索<i class="fa fa-search"></i></button></span>
                       <!--  <span class="mgb15 biaodan" style="padding-top:5px;"><a class="btn1 btn-sm btn-primary"  style="padding:8px 15px;" id="print1" onclick="doPrint1()" href="" >导出<i class="fa fa-print" style="font-size:16px;"></i></a></span> -->
						<script>

						function doPrint1(){
						var daterange1=$('#daterange1').val();
						var cardno1=$('#cardno1').val();
						$("#print1").attr('href',"{:U('Api/expxstj')}?daterange1="+daterange1+"&cardno1="+cardno1);
						}

						</script>
                        </form>
                  </div> 

                   <div id="jqgrid1">
                       <table id="grid-table1"></table>
                       <div id="grid-pager1"></div>
                   </div>        
                </div>

                <div id="btxs" class="tab-pane" >

                    <div class="row search-bar" >
                        <form >
                        <span class="mgb15 biaodan">
                            出货时间<input type="text" name="daterange1" id="daterange2" class="daterange" style="width:310px;"  placeholder="请选择日期" required /> 
                        </span>
						
						<span class="biaodan mgb15">领取状态
							<select id="lingqu_status2" name="lingqu_status">
							   <option value="0">全部</option>
							   <option value="2">已领取</option>						  						   
							   <option value="1">未领取</option>

							</select>
						</span>

                         <span class="biaodan mgb15">
                            <span>订单号 <input type="text" name="cardno2" id="cardno2" style="width:150px;" placeholder="请输入订单号"/></span>
                        </span>
                        <span class="biaodan mgb15"><button type="button" class="btn1 btn-purple btn-sm" onclick="doSearch2()" id="sousuo2">搜索<i class="fa fa-search"></i></button></span>
                       <!--  <span class="mgb15 biaodan" style="padding-top:5px;"><a class="btn1 btn-sm btn-primary"  style="padding:8px 15px;" id="print1" onclick="doPrint1()" href="" >导出<i class="fa fa-print" style="font-size:16px;"></i></a></span> -->
						<script>

						function doPrint2(){
						var daterange2=$('#daterange2').val();
						var cardno2=$('#cardno2').val();
						$("#print2").attr('href',"{:U('Api/expxstj')}?daterange2="+daterange2+"&cardno2="+cardno2);
						}

						</script>
                        </form>
                  </div> 

                   <div id="jqgrid2">
                       <table id="grid-table2"></table>
                       <div id="grid-pager2"></div>
                   </div>        
                </div>
			</div>

</block>






<block name="script">


    <script>
	   

          
				
          $(function(){
            $('#grid-table1').jqGrid({
                url: '{:U("getxstongjilist_kehuduan")}',
                datatype: "json",
               
                height:"100%",
                autowidth:true,
                shrinkToFit:true,
                colModel:[
                    {label:'网吧id',name:'wbid',hidden:true,},
					{label:'操作时间',name:'dtCharuTime',width:100,}, 
					{label:'订单号',name:'post_order_no',width:100,},                   
					{label:'商品信息',name:'info',width:240},
					{label:'支付类型',name:'pay_type',width:60},
					
					{label:'支付信息',name:'sum_payinfo',width:150},
					{label:'机器号',name:'cpname',width:100},
                    {label:'会员卡号',name:'hycardno',width:100},					
                    {label:'操作人',name:'operator',width:60,hidden:true},
                    {label:'领取状态',name:'lingqu_status',hidden:true,width:60},
					
	                {label:'操作',name:'opera',width:60},
					{label:'备注',name:'bz',width:60,hidden:true},
                ],
				
			    gridComplete: function()
				{
                    var ids = $("#grid-table1").jqGrid('getDataIDs');
                    var add,edit,save,del,bangding,info_edit,edit2,wbid,lingqu_status_str,pay_type_str = '';

                    var end_str,sta_str,position_str;                                             										
                
                        for(var i=0;i < ids.length;i++)
                        {
                            var getRow = $('#grid-table1').getRowData(ids[i]);//获取当前的数据行  
                            var colVal = getRow.wbid;             
                            var rownum = ids[i];
							
							var col_info= getRow.info; 
							
							var info_str='';
							
							var col_lingqu_status= getRow.lingqu_status;  
							var col_post_order_no= getRow.post_order_no;  
							
							var col_pay_type= getRow.pay_type;
							if(col_pay_type==0)
							{
							   pay_type_str='吧台售卖';
							}
							else if(col_pay_type==1)
							{
							  pay_type_str= '<span class="label label-sm label-success">客户端微信</span>';
							}
							else if(col_pay_type==2)
							{
							  pay_type_str= '<span class="label label-sm label-success">客户端支付宝</span>';
							}
							else if(col_pay_type==3)
							{
							  pay_type_str='<span class="label label-sm label-warning">客户端现金</span>';
							}
							if(col_lingqu_status=='0')
							{
							    edit2= '<a  onclick=\"delRowData('+rownum+' );\">派送</a>&nbsp;|&nbsp;<a  onclick=\"quxiao('+rownum+' );\">取消</a>';
							}
							else if(col_lingqu_status=='1')
							{
							   edit2='<span class="label label-sm label-success">已派送</span>';
							}
							else if(col_lingqu_status=='2')
							{
							    edit2='<span class="label label-sm label-warning">已取消</span>'; 
							}			  
							 info_str='<a href="#" onclick="ckchuhuomx_khd('+rownum+')">'+col_info+'</a>';
						     $("#grid-table1").jqGrid('setRowData',ids[i],{opera:edit2,info:info_str,pay_type:pay_type_str});
                        }
                    
                    
                    
                },
				
                styleUI : 'Bootstrap',
                rowNum:10,
                viewrecords: true,
				sortorder: "desc",
                pager:'#grid-pager1',
                loadError:function(xhr,status,error){  
                      }, 
        
            });
      
       $('#grid-table1').jqGrid('setGridWidth', $('#jqgrid').width(), true);
         $(window).resize(function(){
                $('#grid-table1').jqGrid('setGridWidth', $(window).width()*0.8, true);
          });
       
  });  

  
            $('.daterange').daterangepicker({
                format:'YYYY-MM-DD hh:mm:ss',
                timePicker: true,
                timePickerIncrement: 1,
                timePickerSeconds:true,
                startDate:moment().startOf('day'),  
                endDate: moment(),
                timePicker12Hour:false,     
                ranges: {  
                           '今天': [moment().startOf('day'), moment().endOf('day')],  
                           '昨天': [moment().subtract('days', 1).startOf('day'), moment().subtract('days', 1).endOf('day')],  
                           '最近7天': [moment().subtract('days', 6).startOf('day'), moment().endOf('day')],  
                           '最近30天': [moment().subtract('days', 29).startOf('day'), moment().endOf('day')],  
                           '本月': [moment().startOf('month'), moment().endOf('month')],  
                           '上月': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]  
                        },        
                locale:{
                    applyLabel:'确定',
                    cancelLabel:'取消',
                    fromLabel:'从',
                    toLabel:'至',
                    daysOfWeek:['周日','周一','周二','周三','周四','周五','周六'],
                    monthNames:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'],
          customRangeLabel: '自定义',
          firstDay : 1
                }

            },function(start,end,label){
      $('#daterange1').val(start.format('YYYY-MM-DD HH:mm:ss') + ' - ' + end.format('YYYY-MM-DD HH:mm:ss'));
      });

    function doSearch1(){
    $('#grid-table1').jqGrid('setGridParam',{
        postData:{                 
            daterange1:$('#daterange1').val(),
            cardno1:$('#cardno1').val(),
			 lingqu_status:$('#lingqu_status').val(),

			
        }
    }).trigger('reloadGrid');
   }

   doSearch1();
   
   
   
   function ckchuhuomx_khd(rowNum)
   {
      var rowData = $('#grid-table1').jqGrid('getRowData',rowNum);
	  var orderNum= rowData['post_order_no'];
      layer.open({
	  type: 2,
	  offset: '100px',
	  title: '销售统计详情',
	  skin: 'layui-layer-lan',
	  maxmin: true,
	  shadeClose: true, //点击遮罩关闭层
	  area : ['930px' , '500px'],
	  content: '{:U("xiaoshoumx_khd")}?post_order_no='+orderNum,
	  });
   }   
   
   
   function delRowData(row)
   {

            var rowData = $('#grid-table1').jqGrid('getRowData',row);
            if(confirm('确定要领取订单号 “'+rowData['post_order_no']+'” 商品吗？'))
            {
                $.post("{:U('shangpin_lingqu_set')}",{post_order_no:rowData['post_order_no']},function(data)
                {   

                    if(data.status==1)
                    {    

         

                             layer.msg('领取成功', {
                              offset: 0,
                              shift: 6,
                              icon: 1,
                              time: 2000,
                            },function()
                            { 
                             var param = JSON.stringify(data);  			 
							var script=document.createElement("script");  
							script.src= 'http://192.168.8.188:51243?a='+param+'&cmdid=3';
							document.body.appendChild(script);
						
                          });

                        $('#grid-table1').trigger('reloadGrid');
                    }
                    else if(data.status==-1)
                    {
                        layer.msg('领取失败', {
                              offset: 0,
                              shift: 6,
                              icon: 2,
                              time: 1000,
                            });
                    }
                });
            }
    }
	
	   function quxiao(row)
   {

            var rowData = $('#grid-table1').jqGrid('getRowData',row);
            if(confirm('确定要取消订单号 “'+rowData['post_order_no']+'” 商品吗？'))
            {
			   
			   
                $.post("{:U('shangpin_lingqu_quxiao_set')}",{post_order_no:rowData['post_order_no']},function(data)
                {   

                    if(data.status==1)
                    {
                          layer.msg('取消成功', {
                              offset: 0,
                              shift: 6,
                              icon: 1,
                              time: 2000,
                            });
                        $('#grid-table1').trigger('reloadGrid');
                    }
                    else if(data.status==-1)
                    {
                        layer.msg('取消失败', {
                              offset: 0,
                              shift: 6,
                              icon: 2,
                              time: 1000,
                            });
                    }
                });
				
				
            }
    }





   

   </script>
   
   
   
   
   
       <script>
	   

          
				
          $(function(){
            $('#grid-table2').jqGrid({
                url: '{:U("getxstongjilist_batai")}',
                datatype: "json",
               
                height:"100%",
                autowidth:true,
                shrinkToFit:true,
                colModel:[
                    {label:'网吧id',name:'wbid',hidden:true,},
					{label:'支付时间',name:'dtInsertTime',width:180,}, 
					{label:'订单号',name:'post_order_no',width:180,},                   
					{label:'商品信息',name:'info',width:160},
					{label:'支付类型',name:'pay_type',width:100},
					{label:'支付金额',name:'sp_je',width:100},
					{label:'支付信息',name:'sum_payinfo',width:150,hidden:true},				
                    {label:'操作人',name:'operator',width:60,hidden:true},
					{label:'使用时间',name:'dtNotifyTime',width:180,},
                  	{label:'备注',name:'bz',width:120},				
	                {label:'操作',name:'isUsed',width:120},
					
                ],
				
			    gridComplete: function()
				{
                    var ids = $("#grid-table2").jqGrid('getDataIDs');
                    var add,edit,save,del,info_edit,edit2,pay_type_str = '';

                    var end_str,sta_str,position_str;                                             										
                
                        for(var i=0;i < ids.length;i++)
                        {
						
                            var getRow = $('#grid-table2').getRowData(ids[i]);//获取当前的数据行  
                            var colVal = getRow.wbid;             
                            var rownum = ids[i];
							
							var col_info= getRow.info; 
							
							var info_str='';
							
							var col_isUsed= getRow.isUsed;  
							//var col_post_order_no= getRow.post_order_no;  
							
							var col_pay_type= getRow.pay_type;

							if(col_pay_type==1)
							{
							  pay_type_str= '<span class="label label-sm label-success">吧台微信</span>';
							}
							else if(col_pay_type==2)
							{
							  pay_type_str= '<span class="label label-sm label-success">吧台支付宝</span>';
							}
							
						    
							if(col_isUsed=='0')
							{
							    edit2= '<a  onclick=\"delRowData('+rownum+' );\">使用</a>';
							}
							else if(col_isUsed=='1')
							{
							   edit2='<span class="label label-sm label-success">已使用</span>';
							}
							
							
										  
							 info_str='<a href="#" onclick="ckchuhuomx('+rownum+')">'+col_info+'</a>';
						     $("#grid-table2").jqGrid('setRowData',ids[i],{opera:edit2,pay_type:pay_type_str,isUsed:edit2});
							 
                        }
                    
                    
                    
                },
				
                styleUI : 'Bootstrap',
                rowNum:10,
                viewrecords: true,
				sortorder: "desc",
                pager:'#grid-pager2',
                loadError:function(xhr,status,error){  
                      }, 
        
            });
      
       $('#grid-table2').jqGrid('setGridWidth', $('#jqgrid').width(), true);
         $(window).resize(function(){
                $('#grid-table2').jqGrid('setGridWidth', $(window).width()*0.8, true);
          });
       
  });  

  
            $('.daterange').daterangepicker({
                format:'YYYY-MM-DD hh:mm:ss',
                timePicker: true,
                timePickerIncrement: 1,
                timePickerSeconds:true,
                startDate:moment().startOf('day'),  
                endDate: moment(),
                timePicker12Hour:false,     
                ranges: {  
                           '今天': [moment().startOf('day'), moment().endOf('day')],  
                           '昨天': [moment().subtract('days', 1).startOf('day'), moment().subtract('days', 1).endOf('day')],  
                           '最近7天': [moment().subtract('days', 6).startOf('day'), moment().endOf('day')],  
                           '最近30天': [moment().subtract('days', 29).startOf('day'), moment().endOf('day')],  
                           '本月': [moment().startOf('month'), moment().endOf('month')],  
                           '上月': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]  
                        },        
                locale:{
                    applyLabel:'确定',
                    cancelLabel:'取消',
                    fromLabel:'从',
                    toLabel:'至',
                    daysOfWeek:['周日','周一','周二','周三','周四','周五','周六'],
                    monthNames:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'],
          customRangeLabel: '自定义',
          firstDay : 1
                }

            },function(start,end,label){
      $('#daterange2').val(start.format('YYYY-MM-DD HH:mm:ss') + ' - ' + end.format('YYYY-MM-DD HH:mm:ss'));
      });

    function doSearch1(){
    $('#grid-table2').jqGrid('setGridParam',{
        postData:{                 
            daterange1:$('#daterange1').val(),
            cardno1:$('#cardno1').val(),
			 lingqu_status:$('#lingqu_status').val(),

			
        }
    }).trigger('reloadGrid');
   }

   doSearch1();
   
   
   
   
   function delRowData(row)
   {

            var rowData = $('#grid-table1').jqGrid('getRowData',row);
            if(confirm('确定要领取订单号 “'+rowData['post_order_no']+'” 商品吗？'))
            {
                $.post("{:U('shangpin_lingqu_set')}",{post_order_no:rowData['post_order_no']},function(data)
                {   

                    if(data.status==1)
                    {    

         

                             layer.msg('领取成功', {
                              offset: 0,
                              shift: 6,
                              icon: 1,
                              time: 2000,
                            },function()
                            { 
                             var param = JSON.stringify(data);  			 
							var script=document.createElement("script");  
							script.src= 'http://192.168.8.188:51243?a='+param+'&cmdid=3';
							document.body.appendChild(script);
						
                          });

                        $('#grid-table1').trigger('reloadGrid');
                    }
                    else if(data.status==-1)
                    {
                        layer.msg('领取失败', {
                              offset: 0,
                              shift: 6,
                              icon: 2,
                              time: 1000,
                            });
                    }
                });
            }
    }
	





  
   </script>
   
   
   <script>
	 $("#myTab4 li").click(function(){
	    var a=$(this).index();
		
		if(a==0){
		  document.onkeydown = function(e){
			if((e||event).keyCode==13)
			$("#sousuo").click();
		  };
		}else if(a==1){
		   document.onkeydown = function(e){
			if((e||event).keyCode==13)
			$("#sousuo1").click();
		   };
		}else if(a==2){
		   document.onkeydown = function(e){
			if((e||event).keyCode==13)
			$("#sousuo2").click();
		   };
		}else if(a==3){
		   document.onkeydown = function(e){
			if((e||event).keyCode==13)
			$("#sousuo3").click();
		   };
		}else if(a==4){
		   document.onkeydown = function(e){
			if((e||event).keyCode==13)
			$("#sousuo4").click();
		   };
		}

	 })
	
	  document.onkeydown = function(e){
        if((e||event).keyCode==13)
        $("#sousuo").click();
      };
	  
	

	   setInterval(get_tgz_RTime,30000);
	   function get_tgz_RTime()
	   {
	             $.post("{:U('Common/get_neworder_kehuduan_list')}",{wbid:0},function(data)
                {                   
 				    if(data['status']==1)
					{
					  $('#grid-table1').trigger('reloadGrid');
					}
					else if(data['status']==-1)
					{
					  //不刷新
					}
                    
                        				
                });
	   }
	   	
   </script>
</block>